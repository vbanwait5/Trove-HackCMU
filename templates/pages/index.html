{% extends "layouts/base.html" %}

{% block content %}
<div class="my-4 mx-4 max-w-6xl p-6">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-5xl font-bold tracking-tight">Dashboard</h1>
      <p class="text-m opacity-70">Welcome back to your dashboard!</p>
    </div>
    <!--<div class="text-right">-->
      <!--<div class="text-xs uppercase opacity-60">Cards Loaded</div>-->
      <!--<div class="text-2xl font-semibold">{{ cards|length }}</div>-->
    <!--</div> -->
  </div>


      <!-- [ breadcrumb ] end -->
      <!-- [ Main Content ] start -->

    <!-- Overview Cards -->
<!--
  <div class="row mb-6">
    <div class="col-md-4 mb-3">
      <div class="rounded rounded-5 shadow-sm p-5 bg-white border border-slate-100">
        <div class="text-xs text-uppercase opacity-60 mb-1">Total Spent</div>
        <div class="text-2xl font-semibold" id="totalSpent">$0</div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="rounded rounded-5 shadow-sm p-5 bg-white border border-slate-100">
        <div class="text-xs text-uppercase opacity-60 mb-1">Remaining</div>
        <div class="text-2xl font-semibold" id="remaining">$0</div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="rounded rounded-5 shadow-sm p-5 bg-white border border-slate-100">
        <div class="text-xs text-uppercase opacity-60 mb-1">Transactions</div>
        <div class="text-2xl font-semibold" id="txCount">0</div>
      </div>
    </div>
  </div>
  -->

  <div class="row mb-6 align-items-stretch">
    <div class="col-md-6 mb-4">
      <div class="rounded rounded-5 shadow-sm p-5 bg-white border border-slate-100 h-100 d-flex flex-column">
        <div class="text text-uppercase opacity-60 mb-6">Daily Advice</div>
        <div class="text-xl font" id="totalSpent"><em>"{{ daily_quote }}"</em></div>
      </div>
    </div>
    <div class="col-md-6 mb-4">
  <div class="rounded rounded-5 shadow-sm p-5 bg-white border border-slate-100 h-100 d-flex flex-column">
    <div class="text text-uppercase opacity-60 mb-6">Daily Savings</div>
    <div class="row d-flex align-items-center">
      <div class="col-9">
        <h3 class="f-w-300 d-flex align-items-center m-b-0">
          <i id="savingsIcon" class="feather icon-arrow-up text-success f-30 m-r-10"></i>
          <span id="savingsAmount">$0.00</span>
        </h3>
      </div>
      <div class="col-3 text-end">
        <p class="m-b-0" id="savingsPercent">0%</p>
      </div>
    </div>
    <div class="progress m-t-30" style="height: 7px;">
      <div id="savingsProgress" class="progress-bar bg-brand-color-1" role="progressbar"
           style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
  </div>
</div>

<script>
  (function(){
    const dailyBudget = 40;              // set daily budget
    const amountSpent = 15;              // <-- replace with actual spent value
    const remaining = dailyBudget - amountSpent;

    const amountEl = document.getElementById("savingsAmount");
    const iconEl = document.getElementById("savingsIcon");
    const percentEl = document.getElementById("savingsPercent");
    const progressEl = document.getElementById("savingsProgress");

    // Update amount shown
    amountEl.textContent = `$${remaining.toFixed(2)}`;

    // Update icon color and direction
    if (remaining < 0) {
      iconEl.className = "feather icon-arrow-down text-danger f-30 m-r-10";
    } else {
      iconEl.className = "feather icon-arrow-up text-success f-30 m-r-10";
    }

    // Calculate percentage
    let percent = (remaining / dailyBudget) * 100;
    if (percent < 0) percent = 0;
    if (percent > 100) percent = 100;

    percentEl.textContent = `${Math.round((remaining/dailyBudget)*100)}%`;

    // Update progress bar
    progressEl.style.width = percent + "%";
    progressEl.setAttribute("aria-valuenow", percent);
  })();
</script>


  </div>
    
      <!-- [ statistics year chart ] start -->
        <div class="row mb-4">
            <div class="col-12 ms-2">
                <div class="card bg-primary w-100">
                <div class="card-header border-0">
                    <h5 class="text-white">Savings</h5>
                </div>
                <div class="card-body" style="padding:0 25px;">
                    <div class="earning-text mb-0">
                    <h3 class="mb-2 text-white f-w-300">$4295.36 <i class="feather icon-arrow-up teal accent-3"></i></h3>
                    <span class="text-uppercase text-white d-block">Total Savings</span>
                    </div>
                    <div id="Widget-line-chart" class="WidgetlineChart2 ChartShadow" style="height:180px;"></div>
                </div>
                </div>
            </div>
            </div>

            <!--
            <div class="card">
                <div class="card-body border-bottom">
                    <div class="row d-flex align-items-center">
                        <div class="col-auto">
                            <i class="feather icon-zap f-30 text-success"></i>
                        </div>
                        <div class="col">
                            <h3 class="f-w-300">235</h3>
                            <span class="d-block text-uppercase">TOTAL IDEAS</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row d-flex align-items-center">
                        <div class="col-auto">
                            <i class="feather icon-map-pin f-30 text-primary"></i>
                        </div>
                        <div class="col">
                            <h3 class="f-w-300">26</h3>
                            <span class="d-block text-uppercase">TOTAL LOCATIONS</span>
                        </div>
                    </div>
                </div>
            </div>
            -->
        <!-- [ statistics year chart ] end -->

<!-- all deals stuff -->
<div class="container-md px-4 my-0">
<!-- Header -->
<div class="d-flex align-items-center justify-content-between mb-4">
<div>
    <h1 class="h3 fw-bold mb-1">Deals Spotlight</h1>
    <!--
    <div class="text-muted small">
    Best offers first — see full details on the <a href="{% url 'cards' %}">My Cards</a> page.
    </div>
    -->
</div>
<!--
<div class="text-end">
    <div class="text-uppercase small text-muted">Cards Loaded</div>
    <div class="fs-4 fw-semibold">{{ cards|length }}</div>
</div>
-->
</div>

<!-- Filter Options -->

<div class="mb-3">
<!--<span class="fw-semibold me-2">Filter Deals:</span>-->
<div id="dealFilters" >
    <!-- Checkboxes are here -->
</div>
</div>

<!-- Deals Grid -->
<div class="d-flex align-items-center justify-content-between mb-3">
<div class="small text-muted" id="dealCount">0 deals</div>
</div>
<div id="dealsGrid" class="row g-4"></div>
</div>

{# Build the deals list from cards #}
{% for c in cards %}
{% if c.welcome_bonus %}
<script>
    (window._deals = window._deals || []).push({
    type: "welcome",
    title: {% if c.welcome_bonus.points %}"{{ c.welcome_bonus.points|floatformat:0 }} pts"{% elif c.welcome_bonus.cash_back %}"${{ c.welcome_bonus.cash_back|floatformat:0 }} cash"{% elif c.welcome_bonus.points_or_cash %}"{{ c.welcome_bonus.points_or_cash|floatformat:0 }} value"{% else %}"Welcome Offer"{% endif %},
    subtitle: {% if c.welcome_bonus.spend_requirement and c.welcome_bonus.time_frame_months %}
        "After ${{ c.welcome_bonus.spend_requirement|floatformat:0 }} in {{ c.welcome_bonus.time_frame_months }} mo"
    {% elif c.welcome_bonus.spend_requirement %}
        "After ${{ c.welcome_bonus.spend_requirement|floatformat:0 }} spend"
    {% elif c.welcome_bonus.time_frame_months %}
        "In {{ c.welcome_bonus.time_frame_months }} months"
    {% else %}
        ""
    {% endif %},
    card: "{{ c.card_name|escapejs }}",
    issuer: "{{ c.issuer|default:'—'|escapejs }}",
    expires: "{{ c.current_period.end_date|default_if_none:''|escapejs }}"
    });
</script>
{% endif %}

{% if c.perks %}
{% for p in c.perks %}
    <script>
    (window._deals = window._deals || []).push({
        type: "perk",
        title: "{{ p.perk_name|escapejs }}",
        subtitle: "{% if p.frequency %}{{ p.frequency|escapejs }}{% elif p.description %}{{ p.description|escapejs }}{% else %}{% endif %}",
        card: "{{ c.card_name|escapejs }}",
        issuer: "{{ c.issuer|default:'—'|escapejs }}",
        expires: "{{ c.current_period.end_date|default_if_none:''|escapejs }}"
    });
    </script>
{% endfor %}
{% endif %}

{% if c.bonus_categories %}
{% for bc in c.bonus_categories %}
    <script>
    (window._deals = window._deals || []).push({
        type: "category",
        title: "{{ bc.category_name|escapejs }}{% if bc.reward_rate %} · {{ bc.reward_rate|floatformat:2 }}x{% endif %}",
        subtitle: "{% if bc.cap %}Cap ${{ bc.cap|floatformat:0 }}{% if bc.note %} · {{ bc.note|escapejs }}{% endif %}{% else %}{% if bc.note %}{{ bc.note|escapejs }}{% endif %}{% endif %}",
        card: "{{ c.card_name|escapejs }}",
        issuer: "{{ c.issuer|default:'—'|escapejs }}",
        expires: "{{ c.current_period.end_date|default_if_none:''|escapejs }}"
    });
    </script>
{% endfor %}
{% endif %}
{% endfor %}

<script>
(function(){
const allDeals = (window._deals || []).filter(Boolean);

// Shuffle array helper (Fisher–Yates)
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// 1. Get unique deal types/tags for filter checkboxes
const tags = Array.from(new Set(allDeals.map(d=>{
if(d.type==='welcome') return 'Welcome';
if(d.type==='perk') return 'Perk';
if(d.type==='category') {
    if(d.title.includes('Travel')) return 'Travel';
    if(d.title.includes('Food')) return 'Food';
    if(d.title.includes('Entertainment')) return 'Entertainment';
    return 'Misc';
}
return 'Other';
})));

// 2. Render filter checkboxes
const filterContainer = document.getElementById('dealFilters');
tags.forEach(tag=>{
const id = 'filter-'+tag;
filterContainer.innerHTML += `
    <div class="form-check form-check-inline">
    <input class="form-check-input deal-filter" type="checkbox" id="${id}" value="${tag}" checked>
    <label class="form-check-label" for="${id}">${tag}</label>
    </div>
`;
});

// 3. Function to render **only 4 random deals** based on selected filters
function renderDeals() {
const checked = Array.from(document.querySelectorAll('.deal-filter:checked')).map(i=>i.value);
const grid = document.getElementById('dealsGrid');
const count = document.getElementById('dealCount');

const filtered = allDeals.filter(d=>{
    let tag = 'Other';
    if(d.type==='welcome') tag='Welcome';
    else if(d.type==='perk') tag='Perk';
    else if(d.type==='category') {
    if(d.title.includes('Travel')) tag='Travel';
    else if(d.title.includes('Food')) tag='Food';
    else if(d.title.includes('Entertainment')) tag='Entertainment';
    else tag='Misc';
    }
    return checked.includes(tag);
});

// Pick 4 random deals
const sample = shuffle([...filtered]).slice(0,4);

count.textContent = `${sample.length} deal${sample.length===1?'':'s'}`;

if(!sample.length){
    grid.innerHTML = '<div class="text-muted small">No current deals.</div>';
    return;
}

grid.innerHTML = sample.map(d=>{
    const cap = [d.card,d.issuer].filter(Boolean).join(' • ');
    const exp = d.expires ? `Ends ${d.expires}` : '';
    let tag = 'Other';
    if(d.type==='welcome') tag='New User Bonus';
    else if(d.type==='perk') tag='Perk';
    else if(d.type==='category'){
    if(d.title.includes('Travel')) tag='Travel';
    else if(d.title.includes('Food')) tag='Food';
    else if(d.title.includes('Entertainment')) tag='Entertainment'; 
    else tag='Food/Entertainment';
    }

    return `
    <div class="col-12 col-md-6">
        <div class="card h-100" style="border-radius:14px;box-shadow:0 8px 24px -12px rgba(0,0,0,.15)">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-1">
            <span class="badge bg-light border text-dark">${tag}</span>
            </div>
            <div class="fw-bold" style="font-size:1.05rem">${d.title || ''}</div>
            ${d.subtitle ? `<div class="text-muted small mt-1">${d.subtitle}</div>` : ''}
            <div class="d-flex align-items-center justify-content-between mt-3">
            <div class="text-muted small">${cap}</div>
            <div class="text-muted small">${exp}</div>
            </div>
        </div>
        </div>
    </div>`;
}).join('');
}

// 4. Initial render
renderDeals();

// 5. Attach event listeners to checkboxes
document.querySelectorAll('.deal-filter').forEach(cb=>{
cb.addEventListener('change', renderDeals);
});
})();
</script>


<!--

<script>
(function(){
const allDeals = (window._deals || []).filter(Boolean);

// 1. Get unique deal types/tags for filter checkboxes
const tags = Array.from(new Set(allDeals.map(d=>{
if(d.type==='welcome') return 'Welcome';
if(d.type==='perk') return 'Perk';
if(d.type==='category') {
    if(d.title.includes('Travel')) return 'Travel';
    if(d.title.includes('Food')) return 'Food';
    if(d.title.includes('Entertainment')) return 'Entertainment';
    return 'Misc';
}
return 'Other';
})));

// 2. Render filter checkboxes
const filterContainer = document.getElementById('dealFilters');
tags.forEach(tag=>{
const id = 'filter-'+tag;
filterContainer.innerHTML += `
    <div class="form-check form-check-inline">
    <input class="form-check-input deal-filter" type="checkbox" id="${id}" value="${tag}" checked>
    <label class="form-check-label" for="${id}">${tag}</label>
    </div>
`;
});

// 3. Function to render deals based on selected filters
function renderDeals() {
const checked = Array.from(document.querySelectorAll('.deal-filter:checked')).map(i=>i.value);
const grid = document.getElementById('dealsGrid');
const count = document.getElementById('dealCount');

const filtered = allDeals.filter(d=>{
    let tag = 'Other';
    if(d.type==='welcome') tag='Welcome';
    else if(d.type==='perk') tag='Perk';
    else if(d.type==='category') {
    if(d.title.includes('Travel')) tag='Travel';
    else if(d.title.includes('Food')) tag='Food';
    else tag='Misc';
    }
    return checked.includes(tag);
});

count.textContent = `${filtered.length} deal${filtered.length===1?'':'s'}`;

if(!filtered.length){
    grid.innerHTML = '<div class="text-muted small">No current deals.</div>';
    return;
}

grid.innerHTML = filtered.slice(0,24).map(d=>{
    const cap = [d.card,d.issuer].filter(Boolean).join(' • ');
    const exp = d.expires ? `Ends ${d.expires}` : '';
    let tag = 'Other';
    if(d.type==='welcome') tag='New User Bonus';
    else if(d.type==='perk') tag='Perk';
    else if(d.type==='category'){
    if(d.title.includes('Travel')) tag='Travel';
    else if(d.title.includes('Food')) tag='Food';
    else if(d.title.includes('Entertainment')) tag='Entertainment'; 
    else tag='Food/Entertainment';
    }

    return `
    <div class="col-12 col-md-6">
        <div class="card h-100" style="border-radius:14px;box-shadow:0 8px 24px -12px rgba(0,0,0,.15)">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-1">
            <span class="badge bg-light border text-dark">${tag}</span>
            </div>
            <div class="fw-bold" style="font-size:1.05rem">${d.title || ''}</div>
            ${d.subtitle ? `<div class="text-muted small mt-1">${d.subtitle}</div>` : ''}
            <div class="d-flex align-items-center justify-content-between mt-3">
            <div class="text-muted small">${cap}</div>
            <div class="text-muted small">${exp}</div>
            </div>
        </div>
        </div>
    </div>`;
}).join('');
}

// 4. Initial render
renderDeals();

// 5. Attach event listeners to checkboxes
document.querySelectorAll('.deal-filter').forEach(cb=>{
cb.addEventListener('change', renderDeals);
});
})();
</script>

-->


        <!-- [ worldLow section ] start -->
        <!--
        <div class="col-xl-8 col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Users From United States</h5>
                </div>
                <div class="card-body">
                    <div id="world-low" style="height:450px;"></div>
                </div>
            </div>
        </div>
        -->
        <!-- [ worldLow section ] end -->


        {% load static %}

    </div>
      <!-- [ Main Content ] end -->
    </div>
  </div>

{% endblock content %}

{% block extra_js %}

<script src="{% static "assets/js/plugins/apexcharts.min.js" %}"></script>
<script src="{% static "assets/js/plugins/jsvectormap.min.js" %}"></script>
<script src="{% static "assets/js/plugins/world.js" %}"></script>
<script src="{% static "assets/js/pages/dashboard-default.js" %}"></script>

{% endblock extra_js %}