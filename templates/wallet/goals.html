{% extends "layouts/base.html" %}

{% block content %}
<div class="mx-auto max-w-6xl p-6">
  <!-- Title -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-3xl font-bold tracking-tight">Credit Card Spending</h1>
      <p class="text-sm opacity-70">Beautiful, responsive dashboard with budget awareness.</p>
    </div>
    <div class="text-right">
      <div class="text-xs uppercase opacity-60">Budget (this period)</div>
      <div class="text-2xl font-semibold">${{ budget|default:1000 }}</div>
    </div>
  </div>

  <!-- Overview Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="rounded-2xl shadow-md p-5 bg-white/60 backdrop-blur border border-slate-100">
      <div class="text-xs uppercase opacity-60 mb-1">Total Spent</div>
      <div class="text-2xl font-semibold" id="totalSpent">$0</div>
    </div>
    <div class="rounded-2xl shadow-md p-5 bg-white/60 backdrop-blur border border-slate-100">
      <div class="text-xs uppercase opacity-60 mb-1">Remaining</div>
      <div class="text-2xl font-semibold" id="remaining">$0</div>
    </div>
    <div class="rounded-2xl shadow-md p-5 bg-white/60 backdrop-blur border border-slate-100">
      <div class="text-xs uppercase opacity-60 mb-1">Transactions</div>
      <div class="text-2xl font-semibold" id="txCount">0</div>
    </div>
    <div class="rounded-2xl shadow-md p-5 bg-white/60 backdrop-blur border border-slate-100">
      <div class="text-xs uppercase opacity-60 mb-1">Avg. / Tx</div>
      <div class="text-2xl font-semibold" id="avgPerTx">$0</div>
    </div>
  </div>

  <!-- Budget Progress -->
  <div class="rounded-2xl shadow-md p-6 bg-white/70 backdrop-blur border border-slate-100 mb-8">
    <div class="flex items-end justify-between mb-3">
      <div>
        <h2 class="text-xl font-semibold">Budget Usage</h2>
        <p class="text-sm opacity-70">Tracks toward your monthly limit.</p>
      </div>
      <div id="thresholdBadge" class="text-xs px-2.5 py-1 rounded-full border hidden"></div>
    </div>

    <div class="relative w-full h-5 rounded-full overflow-hidden bg-slate-100 border border-slate-200" aria-label="Budget progress">
      <div id="progressFill" class="h-full" style="width:0%"></div>
      <div class="absolute inset-0 flex items-center justify-center text-xs font-medium" id="progressLabel">0%</div>
    </div>
    <div class="flex justify-between text-xs opacity-70 mt-2">
      <span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span>
    </div>

    <div id="alerts" class="mt-4 space-y-2"></div>
  </div>

  <!-- Category Goals -->
  <div class="rounded-2xl shadow-md p-6 bg-white/70 backdrop-blur border border-slate-100 mb-8">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold">Spending Goals</h2>
      <button id="addGoalBtn" type="button"
              class="px-3 py-2 rounded-xl border border-slate-200 shadow-md"
              style="background:#ffffff">+ Add Goal</button>
    </div>

    <form id="addGoalForm" method="post" action="{% url 'goals' %}" 
      class="hidden mb-4 p-4 rounded-xl border border-slate-200" style="background:#ffffff">
    {% csrf_token %}
      <div class="grid" style="grid-template-columns:repeat(4,minmax(0,1fr)); gap:.75rem; align-items:end;">
        <div>
          <label class="text-xs opacity-70">Category</label>
          <input name="category" type="text" required class="w-full p-2 rounded-lg border border-slate-200" placeholder="e.g., Food"/>
        </div>
        <div>
          <label class="text-xs opacity-70">Limit ($)</label>
          <input name="limit_amount" type="number" step="0.01" min="0" required class="w-full p-2 rounded-lg border border-slate-200" placeholder="400"/>
        </div>
        <div>
          <label class="text-xs opacity-70">Start</label>
          <input name="period_start" type="date" required class="w-full p-2 rounded-lg border border-slate-200"/>
        </div>
        <div>
          <label class="text-xs opacity-70">End</label>
          <input name="period_end" type="date" required class="w-full p-2 rounded-lg border border-slate-200"/>
        </div>
      </div>
      <div class="mt-3 flex items-center" style="gap:.5rem">
        <button type="submit" class="px-3 py-2 rounded-xl border border-slate-200 shadow-md" style="background:#22c55e; color:white">Save Goal</button>
        <button id="cancelAddGoal" type="button" class="px-3 py-2 rounded-xl border border-slate-200">Cancel</button>
      </div>
    </form>

    <ul class="space-y-3">
      {% for g in goals %}
        <li class="p-3 rounded-xl border border-slate-200 flex items-center justify-between">
          <div>
            <div class="font-medium">{{ g.category }}</div>
            <div class="text-sm opacity-70">
              ${{ g.current_spend }} / ${{ g.limit_amount }}
              <span class="opacity-60">({{ g.period_start }} → {{ g.period_end }})</span>
            </div>
          </div>

          <div class="w-48">
            <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
              {% if g.limit_amount %}
                <div class="h-2"
                     style="width: {% widthratio g.current_spend g.limit_amount 100 %}%;
                            background: linear-gradient(90deg, #22c55e, #f97316, #ef4444);"></div>
              {% else %}
                <div class="h-2" style="width: 0%; background: linear-gradient(90deg, #22c55e, #f97316, #ef4444);"></div>
              {% endif %}
            </div>
            <div class="text-right text-xs mt-1 opacity-70">
              {% if g.limit_amount %}{% widthratio g.current_spend g.limit_amount 100 %}{% else %}0{% endif %}%
            </div>
          </div>
        </li>
      {% empty %}
        <li class="p-3 rounded-xl border border-slate-200">No goals yet.</li>
      {% endfor %}
    </ul>
  </div>

  <!-- Transactions -->
  <div class="rounded-2xl shadow-md p-6 bg-white/70 backdrop-blur border border-slate-100">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold">Recent Transactions</h2>
      <div class="flex items-center" style="gap:.5rem">
        <label class="text-xs opacity-70">Sort by</label>
        <select id="sortKey" style="padding:.35rem .6rem;border:1px solid rgba(15,23,42,.12);border-radius:12px;background:#fff">
          <option value="date" selected>Date</option>
          <option value="amount">Amount</option>
          <option value="category">Type</option>
          <option value="merchant">Merchant</option>
        </select>
        <select id="sortDir" style="padding:.35rem .6rem;border:1px solid rgba(15,23,42,.12);border-radius:12px;background:#fff">
          <option value="desc" selected>Desc</option>
          <option value="asc">Asc</option>
        </select>
      </div>
    </div>
    <div class="overflow-hidden rounded-xl border border-slate-200">
      <table class="w-full text-sm">
        <thead class="bg-slate-50">
          <tr>
            <th class="text-left p-3">Merchant</th>
            <th class="text-left p-3">Category</th>
            <th class="text-left p-3">Date</th>
            <th class="text-right p-3">Amount</th>
          </tr>
        </thead>
        <tbody id="txBody" class="divide-y divide-slate-100"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Minimal styles -->
<style>
  .hidden{display:none}
  :root{--radius:16px;--shadow:0 10px 25px -10px rgba(2,6,23,.15)}
  .rounded-2xl{border-radius:var(--radius)}.shadow-md{box-shadow:var(--shadow)}
  .bg-white\/60{background:rgba(255,255,255,.6)}.bg-white\/70{background:rgba(255,255,255,.7)}
  .border{border:1px solid rgba(15,23,42,.08)}.border-slate-100{border-color:rgba(15,23,42,.06)}.border-slate-200{border-color:rgba(15,23,42,.12)}
  .text-3xl{font-size:1.75rem}.text-2xl{font-size:1.5rem}.text-xl{font-size:1.25rem}.font-bold{font-weight:800}.font-semibold{font-weight:700}.font-medium{font-weight:600}
  .opacity-60{opacity:.6}.opacity-70{opacity:.7}.uppercase{text-transform:uppercase}
  .p-6{padding:1.5rem}.p-5{padding:1.25rem}.p-3{padding:.75rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-4{margin-top:1rem}.mb-4{margin-bottom:1rem}
  .grid{display:grid}.grid-cols-1{grid-template-columns:1fr}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.lg\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}.gap-4{gap:1rem}
  .mx-auto{margin-inline:auto}.max-w-6xl{max-width:72rem}.w-full{width:100%}.w-48{width:12rem}.h-5{height:1.25rem}.h-2{height:.5rem}
  .flex{display:flex}.items-center{align-items:center}.items-end{align-items:flex-end}.justify-between{justify-content:space-between}.justify-center{justify-content:center}.text-right{text-align:right}
  .rounded-full{border-radius:9999px}.overflow-hidden{overflow:hidden}.relative{position:relative}.absolute{position:absolute}.inset-0{inset:0}
  .space-y-3>*+*{margin-top:.75rem}.space-y-2>*+*{margin-top:.5rem}
  .bg-slate-50{background:#f8fafc}.bg-slate-100{background:#f1f5f9}
  .divide-y> :not([hidden])~:not([hidden]){border-top:1px solid rgba(15,23,42,.06)}
</style>

<script>
(function(){
  const budget = Number("{{ budget|default:1000 }}") || 1000;

  // Build from context only
  const serverTx = [
    {% for t in transactions %}
      { merchant: "{{ t.merchant|escapejs }}",
        category: "{{ t.category|escapejs }}",
        date: "{{ t.date|escapejs }}",
        amount: {{ t.amount|default:0 }} }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  // Elements
  const tbody = document.getElementById('txBody');
  const totalSpentEl = document.getElementById('totalSpent');
  const remainingEl = document.getElementById('remaining');
  const txCountEl = document.getElementById('txCount');
  const avgPerTxEl = document.getElementById('avgPerTx');
  const fill = document.getElementById('progressFill');
  const progressLabel = document.getElementById('progressLabel');
  const badge = document.getElementById('thresholdBadge');
  const alerts = document.getElementById('alerts');
  const sortKeyEl = document.getElementById('sortKey');
  const sortDirEl = document.getElementById('sortDir');

  // Animate progress changes
  fill.style.transition = 'width .6s ease, background-color .3s ease';

  function fmt(n){return Number(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}

  function computeStats(rows){
    const total = rows.reduce((s,t)=>s + Number(t.amount||0),0);
    const remaining = Math.max(0, budget - total);
    const pct = Math.max(0, Math.min(100, Math.round((total / (budget||1)) * 100)));

    totalSpentEl.textContent = `$${fmt(total)}`;
    remainingEl.textContent = `$${fmt(remaining)}`;
    txCountEl.textContent = rows.length;
    avgPerTxEl.textContent = `$${fmt(total/Math.max(1,rows.length))}`;

    fill.style.width = pct + '%';
    progressLabel.textContent = pct + '%';

    // Dynamic color: green (<50%), yellow (50–74%), red (75%+)
    const color = pct >= 75 ? '#ef4444' : (pct >= 50 ? '#f59e0b' : '#22c55e');
    fill.style.background = color;

    // Clear prior alerts
    alerts.innerHTML = '';
    badge.classList.add('hidden');

    function pill(text, color){
      badge.textContent = text;
      badge.classList.remove('hidden');
      badge.style.borderColor = color;
      badge.style.color = color;
      badge.style.background = color + '11';
    }
    function alert(text, color){
      const el = document.createElement('div');
      el.className = 'p-3 rounded-xl border';
      el.style.borderColor = color;
      el.style.background = color + '0F';
      el.style.color = color;
      el.textContent = text;
      alerts.appendChild(el);
    }

    if (pct >= 75) {
      pill('75%+ of budget', '#ef4444');
      alert('Warning: You\'ve used over 75% of your budget. Consider pausing discretionary spending.', '#ef4444');
    } else if (pct >= 50) {
      pill('50%+ of budget', '#f59e0b');
      alert('Heads up: You\'ve crossed 50% of your budget.', '#f59e0b');
    } else if (pct >= 25) {
      pill('25%+ of budget', '#0ea5e9');
      alert('Nice tracking! You\'re at 25% of budget. Keep an eye on upcoming bills.', '#0ea5e9');
    }
  }

  function renderTable(rows){
    if (!rows.length){
      tbody.innerHTML = '<tr><td colspan="4" class="p-3 text-center opacity-70">No transactions found</td></tr>';
      return;
    }
    tbody.innerHTML = rows.map(t => `
      <tr>
        <td class="p-3 font-medium">${t.merchant}</td>
        <td class="p-3 opacity-80">${t.category || ''}</td>
        <td class="p-3 opacity-70">${t.date}</td>
        <td class="p-3 text-right font-semibold">$${fmt(t.amount)}</td>
      </tr>
    `).join('');
  }

  function sortRows(rows, key, dir){
    const m = dir === 'asc' ? 1 : -1;
    const arr = rows.slice();
    arr.sort((a,b)=>{
      let A,B;
      if (key === 'date') { A = new Date(a.date); B = new Date(b.date); }
      else if (key === 'amount') { A = Number(a.amount)||0; B = Number(b.amount)||0; }
      else if (key === 'category') { A = (a.category||'').toLowerCase(); B = (b.category||'').toLowerCase(); }
      else if (key === 'merchant') { A = (a.merchant||'').toLowerCase(); B = (b.merchant||'').toLowerCase(); }
      else { A = 0; B = 0; }
      if (A < B) return -1*m;
      if (A > B) return 1*m;
      return 0;
    });
    return arr;
  }

  function apply(){
    const key = sortKeyEl.value || 'date';
    const dir = sortDirEl.value || 'desc';
    const sorted = sortRows(serverTx, key, dir);
    renderTable(sorted);
    computeStats(sorted);
  }

  // Toggle Add Goal form
  const addBtn = document.getElementById('addGoalBtn');
  const addForm = document.getElementById('addGoalForm');
  const cancelBtn = document.getElementById('cancelAddGoal');
  if (addBtn && addForm){ addBtn.addEventListener('click', ()=> addForm.classList.toggle('hidden')); }
  if (cancelBtn && addForm){ cancelBtn.addEventListener('click', ()=> addForm.classList.add('hidden')); }

  sortKeyEl.addEventListener('change', apply);
  sortDirEl.addEventListener('change', apply);

  // Initial render: default date DESC
  apply();
})();
</script>
{% endblock %}
