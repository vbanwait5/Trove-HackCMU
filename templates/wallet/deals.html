{% extends "layouts/base.html" %}

{% block content %}
<div class="container-md px-4 my-5">
  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-4">
    <div>
      <h1 class="h3 fw-bold mb-1">Deals & Card Perks</h1>
      <div class="text-muted small">
        Best offers first — see full details on the <a href="{% url 'cards' %}">My Cards</a> page.
      </div>
    </div>
    <div class="text-end">
      <div class="text-uppercase small text-muted">Cards Loaded</div>
      <div class="fs-4 fw-semibold">{{ cards|length }}</div>
    </div>
  </div>

  <!-- Deals Grid -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="h5 mb-0">Deals Spotlight</h2>
    <div class="small text-muted" id="dealCount">0 deals</div>
  </div>
  <div id="dealsGrid" class="row g-4"></div>
</div>

{# Build the deals list from the cards context #}
{% for c in cards %}
  {% if c.welcome_bonus %}
    <script>
      (window._deals = window._deals || []).push({
        type: "welcome",
        title: {% if c.welcome_bonus.points %}"{{ c.welcome_bonus.points|floatformat:0 }} pts"{% elif c.welcome_bonus.cash_back %}"${{ c.welcome_bonus.cash_back|floatformat:0 }} cash"{% elif c.welcome_bonus.points_or_cash %}"{{ c.welcome_bonus.points_or_cash|floatformat:0 }} value"{% else %}"Welcome Offer"{% endif %},
        subtitle: {% if c.welcome_bonus.spend_requirement and c.welcome_bonus.time_frame_months %}
          "After ${{ c.welcome_bonus.spend_requirement|floatformat:0 }} in {{ c.welcome_bonus.time_frame_months }} mo"
        {% elif c.welcome_bonus.spend_requirement %}
          "After ${{ c.welcome_bonus.spend_requirement|floatformat:0 }} spend"
        {% elif c.welcome_bonus.time_frame_months %}
          "In {{ c.welcome_bonus.time_frame_months }} months"
        {% else %}
          ""
        {% endif %},
        card: "{{ c.card_name|escapejs }}",
        issuer: "{{ c.issuer|default:'—'|escapejs }}",
        expires: "{{ c.current_period.end_date|default_if_none:''|escapejs }}"
      });
    </script>
  {% endif %}

  {% if c.perks %}
    {% for p in c.perks %}
      <script>
        (window._deals = window._deals || []).push({
          type: "perk",
          title: "{{ p.perk_name|escapejs }}",
          subtitle: "{% if p.frequency %}{{ p.frequency|escapejs }}{% elif p.description %}{{ p.description|escapejs }}{% else %}{% endif %}",
          card: "{{ c.card_name|escapejs }}",
          issuer: "{{ c.issuer|default:'—'|escapejs }}",
          expires: "{{ c.current_period.end_date|default_if_none:''|escapejs }}"
        });
      </script>
    {% endfor %}
  {% endif %}

  {% if c.bonus_categories %}
    {% for bc in c.bonus_categories %}
      <script>
        (window._deals = window._deals || []).push({
          type: "category",
          title: "{{ bc.category_name|escapejs }}{% if bc.reward_rate %} · {{ bc.reward_rate|floatformat:2 }}x{% endif %}",
          subtitle: "{% if bc.cap %}Cap ${{ bc.cap|floatformat:0 }}{% if bc.note %} · {{ bc.note|escapejs }}{% endif %}{% else %}{% if bc.note %}{{ bc.note|escapejs }}{% endif %}{% endif %}",
          card: "{{ c.card_name|escapejs }}",
          issuer: "{{ c.issuer|default:'—'|escapejs }}",
          expires: "{{ c.current_period.end_date|default_if_none:''|escapejs }}"
        });
      </script>
    {% endfor %}
  {% endif %}
{% endfor %}

<script>
(function(){
  const all = (window._deals || []).filter(Boolean);
  const uniq = new Map();
  for (const d of all) {
    const key = (d.type||'') + '|' + (d.title||'') + '|' + (d.card||'');
    if (!uniq.has(key)) uniq.set(key, d);
  }
  const deals = Array.from(uniq.values());

  const weight = { welcome: 0, perk: 1, category: 2 };
  deals.sort((a,b)=>{
    const wa = weight[a.type] ?? 9, wb = weight[b.type] ?? 9;
    if (wa !== wb) return wa - wb;
    const ha = (a.expires||'') ? 0 : 1;
    const hb = (b.expires||'') ? 0 : 1;
    if (ha !== hb) return ha - hb;
    return (b.title||'').length - (a.title||'').length;
  });

  const grid = document.getElementById('dealsGrid');
  const count = document.getElementById('dealCount');

  if (!deals.length){
    grid.innerHTML = '<div class="text-muted small">No current deals.</div>';
    count.textContent = '0 deals';
    return;
  }

  count.textContent = `${deals.length} deal${deals.length===1?'':'s'}`;

  grid.innerHTML = deals.slice(0, 24).map(d => {
    const cap = [d.card, d.issuer].filter(Boolean).join(' • ');
    const exp = d.expires ? `Ends ${d.expires}` : '';
    const tag = d.type === 'welcome' ? 'Welcome' : (d.type === 'perk' ? 'Perk' : 'Category');
    return `
      <div class="col-12 col-md-6">
        <div class="card h-100" style="border-radius:14px;box-shadow:0 8px 24px -12px rgba(0,0,0,.15)">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-1">
              <span class="badge bg-light border text-dark">${tag}</span>
            </div>
            <div class="fw-bold" style="font-size:1.05rem">${d.title || ''}</div>
            ${d.subtitle ? `<div class="text-muted small mt-1">${d.subtitle}</div>` : ''}
            <div class="d-flex align-items-center justify-content-between mt-3">
              <div class="text-muted small">${cap}</div>
              <div class="text-muted small">${exp}</div>
            </div>
          </div>
        </div>
      </div>`;
  }).join('');
})();
</script>
{% endblock %}
