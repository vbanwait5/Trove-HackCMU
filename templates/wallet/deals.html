{% extends "layouts/base.html" %}

{% block content %}
<div class="container-md px-4 my-5">
  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-4">
    <div>
      <h1 class="h3 fw-bold mb-1">Deals & Card Perks</h1>
      <div class="text-muted small">
        Best offers first — see full details on the <a href="{% url 'cards' %}">My Cards</a> page.
      </div>
    </div>
    <div class="text-end">
      <div class="text-uppercase small text-muted">Cards Loaded</div>
      <div class="fs-4 fw-semibold">{{ cards|length }}</div>
    </div>
  </div>

  <!-- Filter Options -->
  <div class="mb-3">
    <span class="fw-semibold me-2">Filter Deals:</span>
    <div id="dealFilters" class="d-inline-block">
      <!-- Checkboxes will be injected here -->
    </div>
  </div>

  <!-- Deals Grid -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="h5 mb-0">Deals Spotlight</h2>
    <div class="small text-muted" id="dealCount">0 deals</div>
  </div>
  <div id="dealsGrid" class="row g-4"></div>
</div>

{# Build the deals list from cards #}
{% for c in cards %}
  {% if c.welcome_bonus %}
    <script>
      (window._deals = window._deals || []).push({
        type: "welcome",
        title: {% if c.welcome_bonus.points %}"{{ c.welcome_bonus.points|floatformat:0 }} pts"{% elif c.welcome_bonus.cash_back %}"${{ c.welcome_bonus.cash_back|floatformat:0 }} cash"{% elif c.welcome_bonus.points_or_cash %}"{{ c.welcome_bonus.points_or_cash|floatformat:0 }} value"{% else %}"Welcome Offer"{% endif %},
        subtitle: {% if c.welcome_bonus.spend_requirement and c.welcome_bonus.time_frame_months %}
          "After ${{ c.welcome_bonus.spend_requirement|floatformat:0 }} in {{ c.welcome_bonus.time_frame_months }} mo"
        {% elif c.welcome_bonus.spend_requirement %}
          "After ${{ c.welcome_bonus.spend_requirement|floatformat:0 }} spend"
        {% elif c.welcome_bonus.time_frame_months %}
          "In {{ c.welcome_bonus.time_frame_months }} months"
        {% else %}
          ""
        {% endif %},
        card: "{{ c.card_name|escapejs }}",
        issuer: "{{ c.issuer|default:'—'|escapejs }}",
        expires: "{{ c.current_period.end_date|default_if_none:''|escapejs }}"
      });
    </script>
  {% endif %}

  {% if c.perks %}
    {% for p in c.perks %}
      <script>
        (window._deals = window._deals || []).push({
          type: "perk",
          title: "{{ p.perk_name|escapejs }}",
          subtitle: "{% if p.frequency %}{{ p.frequency|escapejs }}{% elif p.description %}{{ p.description|escapejs }}{% else %}{% endif %}",
          card: "{{ c.card_name|escapejs }}",
          issuer: "{{ c.issuer|default:'—'|escapejs }}",
          expires: "{{ c.current_period.end_date|default_if_none:''|escapejs }}"
        });
      </script>
    {% endfor %}
  {% endif %}

  {% if c.bonus_categories %}
    {% for bc in c.bonus_categories %}
      <script>
        (window._deals = window._deals || []).push({
          type: "category",
          title: "{{ bc.category_name|escapejs }}{% if bc.reward_rate %} · {{ bc.reward_rate|floatformat:2 }}x{% endif %}",
          subtitle: "{% if bc.cap %}Cap ${{ bc.cap|floatformat:0 }}{% if bc.note %} · {{ bc.note|escapejs }}{% endif %}{% else %}{% if bc.note %}{{ bc.note|escapejs }}{% endif %}{% endif %}",
          card: "{{ c.card_name|escapejs }}",
          issuer: "{{ c.issuer|default:'—'|escapejs }}",
          expires: "{{ c.current_period.end_date|default_if_none:''|escapejs }}"
        });
      </script>
    {% endfor %}
  {% endif %}
{% endfor %}

<script>
(function(){
  const allDeals = (window._deals || []).filter(Boolean);

  // 1. Get unique deal types/tags for filter checkboxes
  const tags = Array.from(new Set(allDeals.map(d=>{
    if(d.type==='welcome') return 'Welcome';
    if(d.type==='perk') return 'Perk';
    if(d.type==='category') {
      if(d.title.includes('Travel')) return 'Travel';
      if(d.title.includes('Food')) return 'Food';
      return 'Misc';
    }
    return 'Other';
  })));

  // 2. Render filter checkboxes
  const filterContainer = document.getElementById('dealFilters');
  tags.forEach(tag=>{
    const id = 'filter-'+tag;
    filterContainer.innerHTML += `
      <div class="form-check form-check-inline">
        <input class="form-check-input deal-filter" type="checkbox" id="${id}" value="${tag}" checked>
        <label class="form-check-label" for="${id}">${tag}</label>
      </div>
    `;
  });

  // 3. Function to render deals based on selected filters
  function renderDeals() {
    const checked = Array.from(document.querySelectorAll('.deal-filter:checked')).map(i=>i.value);
    const grid = document.getElementById('dealsGrid');
    const count = document.getElementById('dealCount');

    const filtered = allDeals.filter(d=>{
      let tag = 'Other';
      if(d.type==='welcome') tag='Welcome';
      else if(d.type==='perk') tag='Perk';
      else if(d.type==='category') {
        if(d.title.includes('Travel')) tag='Travel';
        else if(d.title.includes('Food')) tag='Food';
        else tag='Misc';
      }
      return checked.includes(tag);
    });

    count.textContent = `${filtered.length} deal${filtered.length===1?'':'s'}`;

    if(!filtered.length){
      grid.innerHTML = '<div class="text-muted small">No current deals.</div>';
      return;
    }

    grid.innerHTML = filtered.slice(0,24).map(d=>{
      const cap = [d.card,d.issuer].filter(Boolean).join(' • ');
      const exp = d.expires ? `Ends ${d.expires}` : '';
      let tag = 'Other';
      if(d.type==='welcome') tag='Welcome';
      else if(d.type==='perk') tag='Perk';
      else if(d.type==='category'){
        if(d.title.includes('Travel')) tag='Travel';
        else if(d.title.includes('Food')) tag='Food';
        else tag='Misc';
      }

      return `
        <div class="col-12 col-md-6">
          <div class="card h-100" style="border-radius:14px;box-shadow:0 8px 24px -12px rgba(0,0,0,.15)">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-1">
                <span class="badge bg-light border text-dark">${tag}</span>
              </div>
              <div class="fw-bold" style="font-size:1.05rem">${d.title || ''}</div>
              ${d.subtitle ? `<div class="text-muted small mt-1">${d.subtitle}</div>` : ''}
              <div class="d-flex align-items-center justify-content-between mt-3">
                <div class="text-muted small">${cap}</div>
                <div class="text-muted small">${exp}</div>
              </div>
            </div>
          </div>
        </div>`;
    }).join('');
  }

  // 4. Initial render
  renderDeals();

  // 5. Attach event listeners to checkboxes
  document.querySelectorAll('.deal-filter').forEach(cb=>{
    cb.addEventListener('change', renderDeals);
  });
})();
</script>
{% endblock %}
